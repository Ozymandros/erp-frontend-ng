<div class="sales-order-detail">
  <div class="page-header">
    <app-button type="default" routerLink="/sales/orders" icon="arrow-left" ariaLabel="Back to List">
      Back to List
    </app-button>
    <h1 nz-typography>
      {{
        isNewOrder
          ? "Create New Sales Order"
          : "Order " + (order?.orderNumber ?? "â€”")
      }}
    </h1>
  </div>

  <nz-card [nzLoading]="loading">
    @if (isNewOrder) {
      <form
        nz-form
        [formGroup]="orderForm"
        (ngSubmit)="submitOrder()"
        nzLayout="vertical"
      >
        <div nz-row [nzGutter]="24">
          <div nz-col [nzSpan]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Order #</nz-form-label>
              <nz-form-control nzErrorTip="Please enter order number">
                <app-input
                  formControlName="orderNumber"
                  placeholder="SO-0001"
                ></app-input>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Customer</nz-form-label>
              <nz-form-control nzErrorTip="Please select a customer">
                <app-select
                  formControlName="customerId"
                  [options]="customers"
                  labelKey="name"
                  valueKey="id"
                  placeholder="Select customer"
                ></app-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Order Date</nz-form-label>
              <nz-form-control nzErrorTip="Please select order date">
                <nz-date-picker
                  formControlName="orderDate"
                  class="full-width"
                ></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <h3 nz-typography class="lines-title">Order Lines</h3>
        <nz-table
          #linesTable
          [nzData]="lines.controls"
          [nzShowPagination]="false"
          [nzSize]="'small'"
        >
          <thead>
            <tr>
              <th id="th-product" scope="col" nzWidth="40%">Product</th>
              <th id="th-quantity" scope="col" nzWidth="15%">Quantity</th>
              <th id="th-unit-price" scope="col" nzWidth="20%">Unit Price</th>
              <th id="th-line-total" scope="col" nzWidth="15%">Line Total</th>
              <th id="th-remove" scope="col" nzWidth="10%"></th>
            </tr>
          </thead>
          <tbody formArrayName="lines">
            @for (control of lines.controls; track $index) {
              <tr [formGroupName]="$index">
                <td>
                  <nz-form-item>
                    <nz-form-control nzErrorTip="Product required">
                      <app-select
                        formControlName="productId"
                        [options]="products"
                        labelKey="name"
                        valueKey="id"
                        placeholder="Select product"
                      ></app-select>
                    </nz-form-control>
                  </nz-form-item>
                </td>
                <td>
                  <nz-form-item>
                    <nz-form-control nzErrorTip="Min 1">
                      <app-input-number
                        formControlName="quantity"
                        [min]="1"
                      ></app-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </td>
                <td>
                  <nz-form-item>
                    <nz-form-control nzErrorTip="Required">
                      <app-input-number
                        formControlName="unitPrice"
                        [min]="0"
                        [step]="0.01"
                      ></app-input-number>
                    </nz-form-control>
                  </nz-form-item>
                </td>
                <td>
                  ${{
                    (
                      (control.get("quantity")?.value || 0) *
                      (control.get("unitPrice")?.value || 0)
                    ).toFixed(2)
                  }}
                </td>
                <td>
                  <app-button
                    (click)="removeLine($index)"
                    type="link"
                    danger
                    icon="minus"
                    tooltip="Remove line"
                    ariaLabel="Remove line"
                  ></app-button>
                </td>
              </tr>
            }
          </tbody>
        </nz-table>

        <div class="form-actions">
          <app-button
            (click)="addLine()"
            type="dashed"
            icon="plus"
            class="add-line-btn"
          >
            Add Line
          </app-button>

          <div class="total-section">
            <span class="total-label">Grand Total:</span>
            <span class="total-value">${{ calculateTotal().toFixed(2) }}</span>
          </div>
        </div>

        <div class="submit-section">
          <app-button
            btnType="submit"
            type="primary"
            [loading]="submitting"
          >
            Create Order
          </app-button>
        </div>
      </form>
    } @else {
      @if (loadError) {
        <div class="load-error">
          <span nz-icon nzType="exclamation-circle"></span>
          {{ loadError }}
        </div>
      }
      @if (order; as o) {
        <div class="order-info">
          <div class="info-row">
            <span class="info-label">Customer</span>
            <span>{{ o.customerName ?? o.customerId }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Date</span>
            <span>{{ o.orderDate | date: "shortDate" }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <nz-tag [nzColor]="getStatusColor(o.status)">{{ o.status }}</nz-tag>
          </div>
          <div class="info-row">
            <span class="info-label">Total</span>
            <span>${{ o.totalAmount.toFixed(2) }}</span>
          </div>
        </div>

        <h3 nz-typography class="lines-title">Order Lines</h3>
        <nz-table
          #linesTable
          [nzData]="o.lines || []"
          [nzShowPagination]="false"
          [nzSize]="'small'"
        >
          <thead>
            <tr>
              <th id="th-lines-product" scope="col">Product</th>
              <th id="th-lines-qty" scope="col" nzAlign="right">Qty</th>
              <th id="th-lines-unit-price" scope="col" nzAlign="right">Unit Price</th>
              <th id="th-lines-line-total" scope="col" nzAlign="right">Line Total</th>
            </tr>
          </thead>
          <tbody>
            @for (line of linesTable.data; track $index) {
              <tr>
                <td>{{ line.productId }}</td>
                <td nzAlign="right">{{ line.quantity }}</td>
                <td nzAlign="right">${{ line.unitPrice.toFixed(2) }}</td>
                <td nzAlign="right">${{ line.lineTotal.toFixed(2) }}</td>
              </tr>
            }
          </tbody>
        </nz-table>
      }
    }
  </nz-card>
</div>
