<div class="user-detail">
  <div class="page-header">
    <app-button routerLink="/users" icon="arrow-left">
      Back to List
    </app-button>
    <h1 nz-typography>{{ isEditMode ? 'Edit User' : 'Create User' }}</h1>
  </div>

  <nz-card [nzLoading]="loading">
    <form nz-form [formGroup]="userForm" (ngSubmit)="save()">
      <div nz-row [nzGutter]="16">
        <div nz-col [nzXs]="24" [nzSm]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Username</nz-form-label>
            <nz-form-control nzErrorTip="Please input username!">
              <app-input formControlName="username" placeholder="Username"></app-input>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzXs]="24" [nzSm]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Email</nz-form-label>
            <nz-form-control nzErrorTip="Please input a valid email!">
              <app-input formControlName="email" type="email" placeholder="Email"></app-input>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzXs]="24" [nzSm]="12">
          <nz-form-item>
            <nz-form-label>First Name</nz-form-label>
            <nz-form-control>
              <app-input formControlName="firstName" placeholder="First Name"></app-input>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzXs]="24" [nzSm]="12">
          <nz-form-item>
            <nz-form-label>Last Name</nz-form-label>
            <nz-form-control>
              <app-input formControlName="lastName" placeholder="Last Name"></app-input>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      @if (!isEditMode) {
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="12">
            <nz-form-item>
              <nz-form-label nzRequired>Password</nz-form-label>
              <nz-form-control nzErrorTip="Password is required!">
                <app-input formControlName="password" type="password" placeholder="Password"></app-input>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      }

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>Active Status</nz-form-label>
            <nz-form-control>
              <nz-switch formControlName="isActive"></nz-switch>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div class="form-actions">
        <app-button type="primary" btnType="submit" [loading]="saving" [disabled]="!userForm.valid">
          {{ isEditMode ? 'Update' : 'Create' }}
        </app-button>
        <app-button type="default" btnType="button" routerLink="/users">Cancel</app-button>
      </div>
    </form>
  </nz-card>

  <!-- Role Management Card (if canUpdate and in edit mode) -->
  @if (isEditMode && userId && canUpdate()) {
    <nz-card id="manage-roles" class="manage-roles-card">
      <div nz-row nzJustify="space-between" nzAlign="middle" class="manage-roles-header">
        <h3 nz-typography class="manage-roles-title">Manage Roles</h3>
        <span class="manage-roles-subtitle">Assign or unassign roles to this user</span>
      </div>
      <app-role-selector
        [userId]="userId"
        [initialRoles]="userRoles"
        [readonly]="!canUpdate()"
        (rolesChange)="onRolesChange($event)"
      />
    </nz-card>
  }

  <!-- Assigned Roles & Permissions View -->
  @if (isEditMode && user) {
    <nz-card class="roles-permissions-card">
      <h3 nz-typography class="roles-permissions-title">Roles & Permissions</h3>
      @if (userRoles.length === 0) {
        <p nz-paragraph>No roles assigned to this user.</p>
      } @else {
        @for (role of userRoles; track role.id) {
          <nz-card class="role-card">
            <div class="role-card-header">
              <div>
                <h4 nz-typography class="role-name">{{ role.name }}</h4>
                @if (role.description) {
                  <p nz-paragraph class="role-description">{{ role.description }}</p>
                }
              </div>
            </div>
            @if (role.permissions && role.permissions.length > 0) {
              <div class="permissions-section">
                <strong>Permissions:</strong>
                <div class="permissions-list">
                  @for (perm of role.permissions; track perm.id) {
                    <nz-badge [nzStatus]="'success'" [nzText]="perm.module + '.' + perm.action"></nz-badge>
                  }
                </div>
              </div>
            }
          </nz-card>
        }
      }
    </nz-card>
  }
</div>
