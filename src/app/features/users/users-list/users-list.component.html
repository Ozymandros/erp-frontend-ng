@if (permissions$ | async; as p) {
<div>
  <div class="page-header users-list-header">
    <h1>Users Management</h1>
    <div class="header-actions">
      @if (p.canExport) {
        <button nz-button (click)="exportToXlsx('users.xlsx')" class="export-button">
          <span nz-icon nzType="file-excel"></span> Export XLSX
        </button>
      }
      @if (p.canExport) {
        <button nz-button (click)="exportToPdf('users.pdf')" class="export-button">
          <span nz-icon nzType="file-pdf"></span> Export PDF
        </button>
      }

      @if (p.canCreate) {
        <button nz-button nzType="primary" routerLink="/users/new">
          <i nz-icon nzType="plus"></i> Add User
        </button>
      }
    </div>
  </div>

  <nz-card>
    <div class="list-search">
      <!--<span class="list-search__label">Search</span>-->
      <nz-space-compact nzSize="large" class="list-search__compact">
        <nz-input-wrapper>
          <nz-icon nzInputAddonBefore nzType="search" />
          <input
            type="text"
            nz-input
            placeholder="By username or email..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearch()"
          />
        </nz-input-wrapper>
      </nz-space-compact>
    </div>

    <nz-table
      #basicTable
      [nzData]="users"
      [nzLoading]="loading"
      [nzTotal]="total"
      [(nzPageIndex)]="pageIndex"
      [(nzPageSize)]="pageSize"
      [nzFrontPagination]="false"
      (nzPageIndexChange)="onPageChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzScroll]="{ x: '1000px' }"
    >
      <thead>
        <tr>
          <th id="th-username" scope="col">Username</th>
          <th id="th-email" scope="col">Email</th>
          <th id="th-roles" scope="col">Roles</th>
          <th id="th-status" scope="col">Status</th>
          <th id="th-created-at" scope="col">Created At</th>
          @if (p.canUpdate || p.canDelete) {
            <th id="th-actions" scope="col">Actions</th>
          }
        </tr>
      </thead>
      <tbody>
        @for (data of basicTable.data; track data.id) {
          <tr>
            <td>{{ data.username }}</td>
            <td>{{ data.email }}</td>
            <td>
              @for (role of data.roles; track role.id) {
                <nz-tag [nzColor]="'blue'">{{ role.name }}</nz-tag>
              }
            </td>
            <td>
              <nz-tag [nzColor]="data.isActive ? 'success' : 'error'">
                {{ data.isActive ? 'Active' : 'Inactive' }}
              </nz-tag>
            </td>
            <td>{{ data.createdAt | date:'short' }}</td>
            @if (p.canUpdate || p.canDelete) {
              <td>
                <nz-space [nzSize]="8">
                  @if (p.canUpdate) {
                    <button
                      *nzSpaceItem
                      nz-button
                      nzType="link"
                      nz-tooltip
                      nzTooltipTitle="Edit user"
                      [routerLink]="['/users', data.id]"
                    >
                      <span nz-icon nzType="edit"></span>
                    </button>
                  }
                  @if (p.canDelete) {
                    <button
                      *nzSpaceItem
                      nz-button
                      nzType="link"
                      nzDanger
                      nz-tooltip
                      nzTooltipTitle="Delete user"
                      nz-popconfirm
                      nzPopconfirmTitle="Are you sure delete this user?"
                      (nzOnConfirm)="deleteUser(data.id)"
                      nzPopconfirmPlacement="left"
                    >
                      <span nz-icon nzType="delete"></span>
                    </button>
                  }
                </nz-space>
              </td>
            }
          </tr>
        }
      </tbody>
    </nz-table>
  </nz-card>
</div>
}
