<div *ngIf="permissions$ | async as p">
  <div class="page-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
    <h1 style="margin: 0;">Inventory Transactions</h1>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <button *ngIf="p.canExport" nz-button (click)="exportToXlsx()">
        <i nz-icon nzType="file-excel"></i> Export XLSX
      </button>
      <button *ngIf="p.canExport" nz-button (click)="exportToPdf()">
        <i nz-icon nzType="file-pdf"></i> Export PDF
      </button>
    </div>
  </div>

  <nz-card>
    <div style="margin-bottom: 16px; display: flex; gap: 16px; max-width: 400px;">
      <nz-input-group [nzPrefix]="prefixIconSearch">
        <input type="text" nz-input placeholder="Search transactions..." [(ngModel)]="searchTerm" (ngModelChange)="onSearch()" />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <i nz-icon nzType="search"></i>
      </ng-template>
    </div>

    <nz-table
      #basicTable
      [nzData]="data"
      [nzLoading]="loading"
      [nzTotal]="total"
      [(nzPageIndex)]="pageIndex"
      [(nzPageSize)]="pageSize"
      [nzFrontPagination]="false"
      (nzPageIndexChange)="onPageChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzScroll]="{ x: '1000px', y: 'calc(100vh - 400px)' }"
    >
      <thead>
        <tr>
          <th>Type</th>
          <th>Product</th>
          <th>Warehouse</th>
          <th>Quantity</th>
          <th>Date</th>
          <th>Doc Reference</th>
          <th>Transaction ID</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of basicTable.data">
          <td>
            <nz-tag [nzColor]="getTransactionColor(item.transactionType)">
              {{ item.transactionType }}
            </nz-tag>
          </td>
          <td><strong>{{ item.product?.name || item.productId }}</strong></td>
          <td>{{ item.warehouse?.name || item.warehouseId }}</td>
          <td [style.color]="item.quantityChange < 0 ? '#cf1322' : '#3f8600'">
            {{ (item.quantityChange > 0 ? '+' : '') + item.quantityChange }}
          </td>
          <td>{{ item.transactionDate | date:'short' }}</td>
          <td>
             <span *ngIf="item.orderId">
               <i nz-icon nzType="file-text"></i> {{ item.orderId }}
             </span>
             <span *ngIf="!item.orderId" style="color: #bfbfbf;">N/A</span>
          </td>
          <td><small>{{ item.id }}</small></td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>
