<div class="products-list" *ngIf="permissions$ | async as p">
  <div class="page-header">
    <h1>Products Management</h1>
    <div>
      <button *ngIf="p.canExport" nz-button (click)="exportToXlsx('products.xlsx')" style="margin-right: 8px;">
        <span nz-icon nzType="file-excel"></span> Export XLSX
      </button>
      <button *ngIf="p.canExport" nz-button (click)="exportToPdf('products.pdf')" style="margin-right: 8px;">
        <span nz-icon nzType="file-pdf"></span> Export PDF
      </button>

      <button *ngIf="p.canCreate" nz-button nzType="primary" routerLink="/inventory/products/new">
        <span nz-icon nzType="plus"></span>
        Add Product
      </button>
    </div>
  </div>

  <div class="search-bar">
    <nz-input-group [nzSuffix]="suffixIconSearch">
      <input 
        type="text" 
        nz-input 
        placeholder="Search products..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearch()"
      />
    </nz-input-group>
    <ng-template #suffixIconSearch>
      <span nz-icon nzType="search"></span>
    </ng-template>
  </div>

  <nz-table
    #productsTable
    [nzData]="products"
    [nzLoading]="loading"
    [nzPageSize]="pageSize"
    [nzPageIndex]="pageIndex"
    [nzTotal]="total"
    [nzFrontPagination]="false"
    (nzPageIndexChange)="onPageChange($event)"
    (nzPageSizeChange)="onPageSizeChange($event)"
    [nzScroll]="{ x: '800px', y: 'calc(100vh - 350px)' }"
  >
    <thead>
      <tr>
        <th>SKU</th>
        <th>Name</th>
        <th>Unit Price</th>
        <th>Stock</th>
        <th nzWidth="150px" *ngIf="p.canUpdate || p.canDelete">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let product of productsTable.data">
        <td><strong>{{ product.sku }}</strong></td>
        <td>{{ product.name }}</td>
        <td>${{ product.unitPrice.toFixed(2) }}</td>
        <td>
          <nz-tag [nzColor]="product.quantityInStock <= product.reorderLevel ? 'red' : 'green'">
            {{ product.quantityInStock }}
          </nz-tag>
        </td>
        <td *ngIf="p.canUpdate || p.canDelete">
          <button 
            *ngIf="p.canUpdate"
            nz-button 
            nzType="link" 
            nzSize="small"
            [routerLink]="['/inventory/products', product.id]"
          >
            <span nz-icon nzType="edit"></span>
            Edit
          </button>
          <button 
            *ngIf="p.canDelete"
            nz-button 
            nzType="link" 
            nzSize="small"
            nzDanger
            (click)="deleteProduct(product)"
          >
            <span nz-icon nzType="delete"></span>
            Delete
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>
