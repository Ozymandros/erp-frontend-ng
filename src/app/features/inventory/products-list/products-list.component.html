@if (permissions$ | async; as p) {
<div class="page-header">
  <h1 nz-typography>Products Management</h1>
  <div class="header-actions">
    @if (p.canExport) {
      <app-button (click)="exportToXlsx('products.xlsx')" icon="file-excel">
        Export XLSX
      </app-button>
    }
    @if (p.canExport) {
      <app-button (click)="exportToPdf('products.pdf')" icon="file-pdf">
        Export PDF
      </app-button>
    }
    @if (p.canCreate) {
      <app-button type="primary" routerLink="/inventory/products/new" icon="plus">
        Add Product
      </app-button>
    }
  </div>
</div>

<nz-card>
  <div class="search-container">
    <app-input
      [(ngModel)]="searchTerm"
      (ngModelChange)="onSearch()"
      placeholder="By name or SKU..."
      icon="search"
      size="large"
    ></app-input>
  </div>

  <nz-table
    #productsTable
    [nzData]="data"
    [nzLoading]="loading"
    [nzTotal]="total"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    [nzFrontPagination]="false"
    (nzPageIndexChange)="onPageChange($event)"
    (nzPageSizeChange)="onPageSizeChange($event)"
    [nzScroll]="{ x: '800px' }"
  >
    <thead>
      <tr>
        <th id="th-sku" scope="col">SKU</th>
        <th id="th-name" scope="col">Name</th>
        <th id="th-unit-price" scope="col">Unit Price</th>
        <th id="th-stock" scope="col">Stock</th>
        @if (p.canUpdate || p.canDelete) {
          <th id="th-actions" scope="col" nzWidth="150px">Actions</th>
        }
      </tr>
    </thead>
    <tbody>
      @for (item of productsTable.data; track item.id) {
        <tr>
          <td><strong>{{ item.sku }}</strong></td>
          <td>{{ item.name }}</td>
          <td>{{ item.unitPrice | currency }}</td>
          <td>
            <nz-tag [nzColor]="item.quantityInStock <= item.reorderLevel ? 'red' : 'green'">
              {{ item.quantityInStock }}
            </nz-tag>
          </td>
          @if (p.canUpdate || p.canDelete) {
            <td>
              <nz-space>
                @if (p.canUpdate) {
                  <app-button
                    *nzSpaceItem
                    type="link"
                    [routerLink]="['/inventory/products', item.id]"
                    icon="edit"
                    tooltip="Edit Product"
                  ></app-button>
                }
                @if (p.canDelete) {
                  <app-button
                    *nzSpaceItem
                    type="link"
                    danger
                    nz-popconfirm
                    nzPopconfirmTitle="Are you sure you want to delete this product?"
                    (nzOnConfirm)="deleteProduct(item)"
                    icon="delete"
                    tooltip="Delete Product"
                  ></app-button>
                }
              </nz-space>
            </td>
          }
        </tr>
      }
    </tbody>
  </nz-table>
</nz-card>
}
