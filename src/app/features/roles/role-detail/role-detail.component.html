<div class="role-detail">
  <div class="page-header">
    <button nz-button nzType="default" routerLink="/roles" class="back-button">
      <i nz-icon nzType="arrow-left"></i> Back
    </button>
    <h1>{{ isEditMode ? 'Edit Role' : 'Create Role' }}</h1>
  </div>

  <nz-card [nzLoading]="loading">
    <form nz-form [formGroup]="roleForm" (ngSubmit)="save()">
      <nz-form-item>
        <nz-form-label [nzSpan]="4" nzRequired>Role Name</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Please input role name!">
          <input nz-input formControlName="name" placeholder="e.g. Administrator" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="4">Description</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <textarea nz-input formControlName="description" placeholder="Role description..." [nzAutosize]="{ minRows: 2, maxRows: 6 }"></textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="4" [nzSpan]="14">
          <button nz-button nzType="primary" [nzLoading]="saving" [disabled]="!roleForm.valid">
            {{ isEditMode ? 'Update' : 'Create' }}
          </button>
          <button nz-button nzType="default" type="button" routerLink="/roles" class="cancel-button">Cancel</button>
        </nz-form-control>
      </nz-form-item>
    </form>
  </nz-card>

  <!-- Permission Management Card (if canUpdate and in edit mode) -->
  @if (isEditMode && roleId && canUpdate()) {
    <nz-card id="manage-permissions" class="manage-permissions-card">
      <div class="manage-permissions-header">
        <h3 class="manage-permissions-title">Manage Permissions</h3>
        <span class="manage-permissions-subtitle">Assign or unassign permissions to this role</span>
      </div>
      <app-permission-selector
        [roleId]="roleId"
        [initialPermissions]="rolePermissions"
        [readonly]="!canUpdate()"
        (permissionsChange)="onPermissionsChange($event)"
      />
    </nz-card>
  }

  <!-- Assigned Permissions View -->
  @if (isEditMode && role) {
    <nz-card class="permissions-view-card">
      <h3 class="permissions-view-title">Assigned Permissions</h3>
      @if (rolePermissions.length === 0) {
        <p>No permissions assigned to this role.</p>
      } @else {
        <div class="permissions-badges">
          @for (perm of rolePermissions; track perm.id) {
            <nz-badge [nzStatus]="'success'" [nzText]="perm.module + '.' + perm.action"></nz-badge>
          }
        </div>
      }
    </nz-card>
  }
</div>
