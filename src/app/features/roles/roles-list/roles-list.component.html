<div *ngIf="permissions$ | async as p">
  <div class="page-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
    <h1>Roles Management</h1>
    <div>
      <button *ngIf="p.canExport" nz-button (click)="exportToXlsx('roles.xlsx')" style="margin-right: 8px;">
        <span nz-icon nzType="file-excel"></span> Export XLSX
      </button>
      <button *ngIf="p.canExport" nz-button (click)="exportToPdf('roles.pdf')" style="margin-right: 8px;">
        <span nz-icon nzType="file-pdf"></span> Export PDF
      </button>

      <button *ngIf="p.canCreate" nz-button nzType="primary" routerLink="/roles/new">
        <i nz-icon nzType="plus"></i> Add Role
      </button>
    </div>
  </div>

  <nz-card>
    <div style="margin-bottom: 16px; display: flex; gap: 16px;">
      <nz-input-group [nzPrefix]="prefixIconSearch">
        <input type="text" nz-input placeholder="Search roles..." [(ngModel)]="searchTerm" (ngModelChange)="loadData()" />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <i nz-icon nzType="search"></i>
      </ng-template>
    </div>

    <nz-table
      #basicTable
      [nzData]="roles"
      [nzLoading]="loading"
      [nzTotal]="total"
      [(nzPageIndex)]="pageIndex"
      [(nzPageSize)]="pageSize"
      [nzFrontPagination]="false"
      (nzPageIndexChange)="loadRoles()"
      (nzPageSizeChange)="loadRoles()"
      [nzScroll]="{ x: '1000px', y: 'calc(100vh - 400px)' }"
    >
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Permissions</th>
          <th>Created At</th>
          <th *ngIf="p.canUpdate || p.canDelete">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data">
          <td><strong>{{ data.name }}</strong></td>
          <td>{{ data.description || '-' }}</td>
          <td>
            <nz-tag *ngFor="let perm of (data.permissions || []) | slice:0:3" [nzColor]="'orange'">
              {{ perm.module }}:{{ perm.action }}
            </nz-tag>
            <span *ngIf="(data.permissions.length || 0) > 3">...</span>
          </td>
          <td>{{ data.createdAt | date:'short' }}</td>
          <td *ngIf="p.canUpdate || p.canDelete">
            <a *ngIf="p.canUpdate" [routerLink]="['/roles', data.id]" style="margin-right: 8px;">Edit</a>
            <a
              *ngIf="p.canDelete"
              nz-popconfirm
              nzPopconfirmTitle="Are you sure delete this role?"
              (nzOnConfirm)="deleteRole(data.id)"
              nzPopconfirmPlacement="left"
              style="color: #ff4d4f; margin-left: 8px;"
            >Delete</a>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>
